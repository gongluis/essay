<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>crowdSourcing - 小巩的网站</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/fontawesome.min.css" rel="stylesheet">
        <link href="../css/brands.min.css" rel="stylesheet">
        <link href="../css/solid.min.css" rel="stylesheet">
        <link href="../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">小巩的网站</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href=".." class="nav-link">介绍</a>
                            </li>
                            <li class="nav-item">
                                <a href="../audioVideo/" class="nav-link">音视频</a>
                            </li>
                            <li class="nav-item">
                                <a href="../java/" class="nav-link">JAVA</a>
                            </li>
                            <li class="nav-item">
                                <a href="../sdk/" class="nav-link">sdk笔记</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Android</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../fourcomponent/" class="dropdown-item">四大组件</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">设计模式</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../designpattern/singleInstance/" class="dropdown-item">单例</a>
</li>
            
<li>
    <a href="../designpattern/factory/" class="dropdown-item">工厂</a>
</li>
            
<li>
    <a href="../designpattern/builder/" class="dropdown-item">Builder</a>
</li>
            
<li>
    <a href="../designpattern/observer/" class="dropdown-item">观察者</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">自定义控件</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../customView/customCombinationView/" class="dropdown-item">自定义组合控件</a>
</li>
            
<li>
    <a href="../customView/customView/" class="dropdown-item">自定义View</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">APP架构</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../constructure/mvc/" class="dropdown-item">MVC</a>
</li>
            
<li>
    <a href="../constructure/font_updown.md" class="dropdown-item">MVP</a>
</li>
            
<li>
    <a href="../constructure/font_updown.md" class="dropdown-item">MVvm</a>
</li>
    </ul>
  </li>
                                    
<li>
    <a href="../touchEvent/" class="dropdown-item">事件分发</a>
</li>
                                    
<li>
    <a href="../handler/" class="dropdown-item">Handler原理</a>
</li>
                                    
<li>
    <a href="../sdkversion/" class="dropdown-item">Android版本对应SDK版本</a>
</li>
                                    
<li>
    <a href="../better/" class="dropdown-item">APP整体优化</a>
</li>
                                    
<li>
    <a href="../app_start_process/" class="dropdown-item">APP启动流程</a>
</li>
                                    
<li>
    <a href="../adaption/" class="dropdown-item">屏幕适配</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">一些小的点</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../context/" class="dropdown-item">ConText</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">一些常见功能的思考</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../login.md" class="dropdown-item">登录</a>
</li>
    </ul>
  </li>
                                    
<li>
    <a href="../test/" class="dropdown-item">单元测试Monkey</a>
</li>
                                    
<li>
    <a href="../UpdateApp/" class="dropdown-item">apk升级</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Flutter插件</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../whyflutterplugin/" class="dropdown-item">什么是flutter插件及作用</a>
</li>
                                    
<li>
    <a href="../howflutterenvironment/" class="dropdown-item">如何配置flutter环境</a>
</li>
                                    
<li>
    <a href="../flutterplugincoding/" class="dropdown-item">flutter插件开发</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">git</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../git_scenes/" class="dropdown-item">常见场景操作</a>
</li>
                                    
<li>
    <a href="../git_client_steps/" class="dropdown-item">Android端git版本管理</a>
</li>
                                    
<li>
    <a href="../git_commit_log/" class="dropdown-item">commit log</a>
</li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">故障复盘记录</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../sdkexception/" class="dropdown-item">AndroidSDK故障记录</a>
</li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            
            
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<blockquote>
<p>视频抽帧方法总结</p>
</blockquote>
<p>视频文件可以分解成一帧一帧的图片，本文要分享的部分就是根据具体的时间戳从制定的视频文件中抽取对应的帧图片。尝试过三种方式。</p>
<pre><code>1. 采用安卓原生api的抽帧方式
2. 采用FFmpegMediaMetadataRetriever三方github开源库的方式
3. 采用MediaCodec 调用系统硬件编解码器类进行抽帧 速度最快
</code></pre>
<h4 id="api">一、安卓原生api的抽帧方式</h4>
<blockquote>
<p>缺点是在某些机型会存在截图失败率高的问题，在频繁操作的业务场景下也会出现失败的情况。</p>
</blockquote>
<pre><code>fun getFrameBitmap(uri: String, isSd: Boolean = true): Bitmap? {
        var bitmap: Bitmap? = null
        //MediaMetadataRetriever 是android中定义好的一个类，提供了统一的接口，用于从输入的媒体文件中取得帧和元数据
        val retriever = MediaMetadataRetriever()
        try {
            if (isSd) {
                //（）根据文件路径获取缩略图
                retriever.setDataSource(context, Uri.fromFile(File(uri)))
            } else {
                //根据网络路径获取缩略图
                retriever.setDataSource(uri, HashMap())
            }
            //获得第一帧图片
            bitmap = retriever.frameAtTime
        } catch (e: IllegalArgumentException) {
            LogUtils.e(TAG, e)
        } finally {
            retriever.release()
        }
        return bitmap
    }
</code></pre>
<h4 id="ffmpeg">二、三方库FFMPEG</h4>
<blockquote>
<p>该库是对原生方案的升级，截图速度仍不理想，超过1s。</p>
</blockquote>
<pre><code> public static Bitmap getPicFromMp4(long timeMillis, File file) {
        if (file == null) {
            Log.d(TAG, &quot;file == null： &quot;);
            return null;
        }
        //1.先解密视频
        Bitmap bitmap = null;
        try {

            //Mp4FileUtils.deCodeRecoveryMp4File(file.getAbsoluteFile());
            LogExtKt.log(TAG, &quot;getPicFromMp4: &quot; + file.getAbsoluteFile());
            FFmpegMediaMetadataRetriever mmr = new FFmpegMediaMetadataRetriever();
            mmr.setDataSource(file.getAbsolutePath());

            long start = System.currentTimeMillis();
            //单位微秒 OPTION_CLOSEST 最近的i帧,  OPTION_PREVIOUS_SYNC 前一个i帧 ，OPTION_NEXT_SYNC后一个i帧，OPTION_CLOSEST 最近的帧，需要decode多张frame才能接近输入的timestamp，因此速度会慢些。
            bitmap = mmr.getFrameAtTime(timeMillis * 1000, FFmpegMediaMetadataRetriever.OPTION_CLOSEST); // frame at 2 seconds
            if(bitmap == null){
                LogExtKt.log(TAG, &quot;getFrameAtTime bitmap == null： &quot;);
            }
            LogExtKt.log(TAG, &quot;interceptPic spend time： &quot; + (System.currentTimeMillis() - start));
            mmr.release();
            //3.将视频加密回去
            //Mp4FileUtils.enCodeRecoveryMp4File(file);
        } catch (Exception e) {
            e.printStackTrace();
            mmr.release();
            Mp4FileUtils.enCodeRecoveryMp4File(file);
            LogExtKt.log(TAG, &quot;getPicFromMp4 exception: &quot;+e.getMessage());
            return null;
        }
        return bitmap;
    }
</code></pre>
<h4 id="mediacodec">三、MediaCodeC方案调动系统硬件编解码器进行抽帧</h4>
<blockquote>
<p>目前最优解，截图速度最快差不多三百毫秒，对于系统内存和cpu占用率也比较理想</p>
</blockquote>
<pre><code>/**
     * 视频抽帧
     * context:[Context]
     * path:[Long]视频路径
     * timestamps:[Long]截取视频的时间戳(微妙)
     * callBack:[MediaCallBack]Bitmap回调
     */
    fun cutVideoFrame(
        path: String,
        timeUs: Long,
        callBack: MediaCallBack
    ) {
        var count = 0
        log(TAG, &quot;start path: $path&quot;)
        val file = File(path)
        val exists = file.exists()
        val canRead = file.canRead()
        val canWrite = file.canWrite()
        log(TAG, &quot;media path:$path&quot;)
        log(TAG, &quot;media exists:$exists canRead:$canRead canWrite:$canWrite&quot;)
        var videoFormat: MediaFormat? = null
        val mediaExtractor = MediaExtractor()
        try {
            mediaExtractor.setDataSource(path)
        } catch (e: Exception) {
            callBack.onFailure(&quot;file not exits&quot;)
            return
        }
        val trackCount = mediaExtractor.trackCount
        log(TAG, &quot;trackCount : $trackCount&quot;)
        for (i in 0 until trackCount) {
            val trackFormat = mediaExtractor.getTrackFormat(i)
            if (trackFormat.getString(MediaFormat.KEY_MIME)?.contains(&quot;video&quot;) == true) {
                videoFormat = trackFormat
                mediaExtractor.selectTrack(i)
                break
            }
        }
        log(TAG, &quot;MediaFormat : $videoFormat&quot;)
        if (videoFormat == null) {
            callBack.onFailure(&quot;videoFile cannot read&quot;)
            return
        }
        videoFormat.setInteger(
            MediaFormat.KEY_COLOR_FORMAT,
            MediaCodecInfo.CodecCapabilities.COLOR_FormatYUV420Flexible
        )
        videoFormat.setInteger(MediaFormat.KEY_WIDTH, videoFormat.getInteger(MediaFormat.KEY_WIDTH))
        videoFormat.setInteger(
            MediaFormat.KEY_HEIGHT,
            videoFormat.getInteger(MediaFormat.KEY_HEIGHT)
        )
        if (videoFormat.containsKey(MediaFormat.KEY_ROTATION)) {
            val rotate = videoFormat.getInteger(MediaFormat.KEY_ROTATION)
        }
        val duration = videoFormat.getLong(MediaFormat.KEY_DURATION)
        var frameRate = videoFormat.getInteger(MediaFormat.KEY_FRAME_RATE)
        val diff = 1000_000 / frameRate
        log(TAG, &quot;frameRage:$frameRate diff:$diff&quot;)
        val codec =
            MediaCodec.createDecoderByType(videoFormat.getString(MediaFormat.KEY_MIME)!!)
        codec.configure(videoFormat, null, null, 0)
        codec.start()

        val bufferInfo = MediaCodec.BufferInfo()
        var inputDone = false
        var outputDone = false
        mediaExtractor.seekTo(timeUs, MediaExtractor.SEEK_TO_PREVIOUS_SYNC)
        Log.i(TAG, &quot;seekTo: $timeUs&quot;)
        var getFrame = false
        while (!outputDone) {
            if (!inputDone) {
                //获取输入缓存
                val inputBufferIndex = codec.dequeueInputBuffer(30)
                if (inputBufferIndex &gt;= 0) {
                    Log.i(TAG, &quot;inputBufferIndex: $inputBufferIndex&quot;)
                    var keyTime = mediaExtractor.sampleTime
                    var sampleFlags = mediaExtractor.sampleFlags
                    Log.i(TAG, &quot;sampleTime: $keyTime  sampleFlags:$sampleFlags&quot;)
                    val inputBuffer = codec.getInputBuffer(inputBufferIndex)
                    val readSampleData = mediaExtractor.readSampleData(inputBuffer!!, 0)
                    Log.i(TAG, &quot;readSampleData: $readSampleData&quot;)
                    if (readSampleData &gt; 0) {
                        if (keyTime == timeUs) {
                            getFrame = true
                        }
                        codec.queueInputBuffer(
                            inputBufferIndex,
                            0,
                            readSampleData,
                            keyTime,
                            if (getFrame) MediaCodec.BUFFER_FLAG_END_OF_STREAM else 0
                        )
                        Log.i(TAG, &quot;queueInputBuffer nowTime: $keyTime &quot;)

                        if (!getFrame) {
                            mediaExtractor.advance()
                            keyTime = mediaExtractor.sampleTime
                            sampleFlags = mediaExtractor.sampleFlags
                            if (keyTime &gt;= timeUs - diff / 2 &amp;&amp; keyTime &lt;= timeUs + diff / 2 || keyTime &gt;= timeUs) {
                                //当前时间到达指定时间戳附件，即帧间隔的一半
                                getFrame = true
                                Log.i(TAG, &quot;getFrame &quot;)
                            }
                        } else {
                            inputDone = true
                            Log.i(TAG, &quot;inputDone &quot;)
                        }
                    } else {
                        codec.queueInputBuffer(
                            inputBufferIndex,
                            0,
                            0,
                            0,
                            MediaCodec.BUFFER_FLAG_END_OF_STREAM
                        )
                        inputDone = true
                    }
                }
            }
            val outputBufferIndex = codec.dequeueOutputBuffer(bufferInfo, 30)

            if (outputBufferIndex &gt;= 0) {
                count++
                Log.i(
                    TAG,
                    &quot;outputBufferIndex: $outputBufferIndex count:${count} flag:${bufferInfo.flags}&quot;
                )
                val image = codec.getOutputImage(outputBufferIndex)
                Log.i(TAG, &quot;getOutputImage: $image&quot;)
                if (bufferInfo.flags == MediaCodec.BUFFER_FLAG_END_OF_STREAM || bufferInfo.flags == 5) {
                    outputDone = true
                    if (image != null) {
                        log(
                            TAG,
                            &quot;getOutputImage count:$count  width:${image.width}  height:${image.height}&quot;
                        )
                        val imageToBitmap = MediaUtil.imageToBitmap(image)
                        callBack.onSuccess(imageToBitmap)
                    } else {
                        callBack.onFailure(&quot;&quot;)
                    }
                    Log.i(TAG, &quot;outputDone&quot;)
                }
                codec.releaseOutputBuffer(outputBufferIndex, false)
            }
        }
        codec.stop()
        codec.release()
        mediaExtractor.release()
        Log.i(TAG, &quot;release&quot;)
    }

    interface MediaCallBack {
        fun onSuccess(bitmap: Bitmap?)

        fun onFailure(msg: String)
    }
</code></pre>
<p>调用：</p>
<pre><code>MediaManager.INSTANCE.cutVideoFrame(interceptFile.getAbsolutePath(), interceptTimeMillis * 1000, new MediaManager.MediaCallBack() {
            @Override
            public void onSuccess(@Nullable Bitmap picFromMp4) {

            }
            @Override
            public void onFailure(@NonNull String msg) {
            }
        });
</code></pre>
<blockquote>
<p>附注：参考博客</p>
<p>https://www.jianshu.com/p/12c3da125ece</p>
</blockquote></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
