<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>智能POS - Luis Docs</title>
        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap-3.0.3.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
            <div class="container">

                <!-- Collapsed navigation -->
                <div class="navbar-header">
                    <!-- Expander button -->
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <a class="navbar-brand" href="..">Luis Docs</a>
                </div>

                <!-- Expanded navigation -->
                <div class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li >
                                <a href="..">首页</a>
                            </li>
                            <li >
                                <a href="../test/">关于</a>
                            </li>
                            <li >
                                <a href="../contact/">联系</a>
                            </li>
                            <li class="active">
                                <a href="./">智能POS</a>
                            </li>
                            <li >
                                <a href="../show_money/">云收银</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li >
                                <a rel="next" href="../contact/">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li >
                                <a rel="prev" href="../show_money/">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        <li class="main active"><a href="#smartpos">SmartPos</a></li>
            <li><a href="#_1">项目依赖关系</a></li>
            <li><a href="#_2">激活模块</a></li>
        <li class="main "><a href="#api">api</a></li>
            <li><a href="#_3">收单服务平台</a></li>
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h1 id="smartpos">SmartPos</h1>
<h2 id="_1">项目依赖关系</h2>
<p><img alt="posstructure" src="https://i.loli.net/2019/04/11/5caf069822108.png" />  </p>
<h2 id="_2">激活模块</h2>
<ol>
<li>build.gradle里面的depandence中<ul>
<li>implementation project(':PosSDK')</li>
<li>implementation project(':jbig-kit')</li>
<li>implementation project(':kprogresshud')</li>
</ul>
</li>
<li>MyApplication中初始化<ul>
<li>CILSDK.setCILAppVersion();</li>
<li>CILSDK.setDebug(BuildConfig.DEBUG);</li>
<li>CILSDK.setAddress(BuildConfig.ADDRESS);</li>
<li>CILSDK.connect(this);</li>
<li>如果还适配了联迪A8，login需要传入activity的context建议在每个可能调用设备刷卡，加密，打印的actiivty调用CILSDK.connect()保证使用过程中设备连接不断开推荐使用activitylifecyclerCallbacks.</li>
</ul>
</li>
<li>
<p>SplashActivity</p>
<ul>
<li>设置了activity的进入动画。</li>
<li>下方设置了版本号+背景颜色表示不同环境。</li>
<li>跑了一个handler(根据是否激活和是否下载参数来进入MainActivity还是ActivateActivity)。  </li>
</ul>
</li>
<li>
<p>ActivateActivity</p>
<ul>
<li>两种激活方式<ul>
<li>扫二维码</li>
<li>输入商户号和终端号（要求在服务平台手动录入sn号）<br />
两种方式的区别：扫二维码比手输多了个去服务平台请求商户号和终端号的接口</li>
</ul>
</li>
<li>激活的过程（服务平台）<ul>
<li>扫二维码：读码成功立马调用getMerchantInfo获取商户信息，点击激活按钮调用activeDevice接口（接口内部调用了downloadParameters终端参数下载接口+notifyActive激活完成）</li>
<li>输入商户号和终端号：active+loadparameters</li>
<li>ACTIVE:服务平台激活</li>
<li>LOADPARAMETERS:下载交易需要的相关信息；交易Ip和端口，币种，超时时间，权限，报文加密标志位。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>MainActivity  </p>
<ul>
<li>检查APP版本  jobScheldure  后台服务进行下载apk</li>
<li>终端密钥下载  <ul>
<li>下载RSA-&gt;装载RSA-&gt;下载主密钥-&gt;装载主密钥-&gt;启用主密钥-&gt;下载工作密钥-&gt;装载工作密钥-&gt;下载aids-&gt;装载aids-&gt;下载ICPKS-&gt;装载ICPKS  </li>
<li></li>
</ul>
</li>
<li>签到（更新工作密钥（下载+装载工作密钥）的过程）网关平台要求应用每天签到一次  <ul>
<li>CILSDK.signIn()  </li>
</ul>
</li>
</ul>
</li>
</ol>
<p>6.交易  </p>
<ul>
<li>扫码交易<ul>
<li>先检查本地缓存的币种与交易报文的币种是否一致  check transe currency<ul>
<li>不一致---&gt;结算</li>
<li>一致，继续</li>
</ul>
</li>
<li>最小交易金额Math.pow(10,-2)   0.01    根据交易币种小数位来确定</li>
<li></li>
</ul>
</li>
<li>银行卡交易  </li>
</ul>
<h1 id="api">api</h1>
<h2 id="_3">收单服务平台</h2>
<ol>
<li>getMerName   终端注册码获取商户信息接口    <ul>
<li>ActiveActivity的onActivityResult中调用</li>
<li>sdk中调用</li>
</ul>
</li>
<li>active  获取Authentication Token接口     <ul>
<li>旧版本激活方式使用的是devicetoken(推送模块生成)</li>
</ul>
</li>
<li>activeCode  新激活接口，使用激活码<ul>
<li>激活码方式激活使用的是sn，token传的null  </li>
</ul>
</li>
</ol>
<p>graph TD;<br />
    A--&gt;B;
    A--&gt;C;
    B--&gt;D;
    C--&gt;D;</p>
<h3 id="sdk">sdk功能点整理</h3>
<h4 id="app">激活模块（在录入终端的时候需要选择方式）  app~收单服务平台</h4>
<ol>
<li>传统输入商户号和终端号的方式激活（重置的方法是清空sn号然后点击确定）<ul>
<li>调用sdk激活接口<br />
CILSDK.active(merCode, termCode, callback); </li>
<li>接口调用成功后立马调用终端参数下载接口下载交易时使用的参数
CILSDK.downloadParam(mer,term,callback);</li>
<li>跳转到MainActivity onCreat的时候调用终端密钥下载接口
CILSDK.downloadParamWithProgress(callback);  </li>
</ul>
</li>
</ol>
<p>汇总：<br />
    1.sp的抽取<br />
        &emsp; 传入三个参数put(Context context,String str,Object &emsp; object),根据object的类型，选择putString还是putInt。。。get(...)同上
    2.KProgressHUD  github上第三方包直接引用源代码
    3.抽取CILlog类，只有在debug模式下才输出日志，另使用sd记录一些错误日志
    4.存储sn（会率先使用A没有后然后使用B）
         &emsp; A.virtualSN：使用激活码激活成功后，服务平台会返回sn，存储到sp
         &emsp; B.REAL_SN：a8,联迪。。。在设备连接的时候会获取一个REAL_SN<br />
    5.devicetoken<br />
         &emsp; 推送平台使用的设备唯一标识识别，可以通过推送服务的注册获得<br />
         &emsp; 旧版本激活前如果devicetoken为空，会尝试进行重新注册一次来获取devicetoken,如果依然为空，传 ""  <br />
    6.versionname
        &emsp;  2.4.0：20190527：SDK<br />
    7.激活同步、异步--------&gt;是否使用RXjava进行切换的区别<br />
    8.激活成功后进行参数下载，sn号传的null值，然后通过4.获取真正的sn
    9.参数下载（交易相关的）：流水号，批次号，交易币种，交易ip,商户信息，全报文加密标志位</p>
<ol>
<li>输入/扫描激活码激活设备  <ul>
<li>通过打开扫描页面扫激活码，在扫码成功的回调中根据激活码查询商户名等信息<br />
CILSDK.getMechantInfo(activeCode,time.appVersion);</li>
<li>点击激活按钮调用激活码激活接口
CILSDK.activeWithCode(activeCode,deviceToken, callback);   </li>
<li>激活接口调用成功后紧接着调用下载终端参数的接口
CILSDK.downloadParamWithProgress(callback);</li>
</ul>
</li>
</ol>
<h4 id="_4">终端密钥下载</h4>
<p>终端密钥下载只需要成功执行一次即可，密钥会被转载到POS的硬件模块<br />
* 下载RSA公钥
* 装载RSA公钥
* 下载主密钥
* 装载主密钥
* 启用主密钥
* 下载工作密钥
* 装载工作密钥
* 下载AIDS
* 装载AIDS
* 下载ICPKS
* 装载ICPKS
* 上送联机版本号
激活完成接口<br />
CILSDK.notifyActived(mer,term);  </p>
<h3 id="_5">交易</h3>
<h4 id="_6">扫码交易（不需要硬件模块读卡器）</h4>
<ul>
<li>扫码消费consume<br />
request.setAmount()<br />
request.setScanCode()<br />
request.setOrderId()<br />
CILSDK.consumeQr(request,callback); 
在callback中判断如果有应答09/98需要发起查询操作<br />
CILSDK.QueryQr(request,callback);//查询6次10s不超过60s,查询出结果返回，如果最后一次仍然是09、98sdk会自动发起取消操作   </li>
<li>扫码取消/冲正cancel<br />
CILSDK.sCanCodeCancel(request,callback);</li>
<li>扫码撤销revoke
CILSDK.revokConsumerQr(request,callback);  </li>
<li>扫码退货refund  </li>
<li>CILSDK.returnConsumeQr  </li>
</ul>
<h4 id="msccardiccard-nfccardmsccard">刷卡交易区分卡类型（mscCard,icCard ,nfcCard,默认使用mscCard）</h4>
<p>通过继承BaseCardActivity复写
getAmount()接口方法   通过跳转的时候传过来 
cardReaderHandler()  读卡信息的接听返回</p>
<p>密码键盘调用
1.在BaseCardActivity的oncreat方法中实例话的类MyPosTransferListener中有个方法监听键盘事件sendPinRequest(String accNo).
2.监听被带进cardEventDelegate---&gt;Pos---&gt;指定的卡事件处理类
3.输入密码时候锁住当前线程</p>
<p>CILSDK 类直接对外提供方法的类
SwipCardTrade 类中处理刷卡相关报文的发送
transactionUtils 交易相关的辅助类<br />
cardEventDelegate 代理卡片事件管理  basecardactyivity调用这个类 </p>
<p>读卡
打开键盘
完成读卡
失败</p>
<p>通过startactivityforResult   返回时判断requestcode来处理unlock线程
每个品牌posreader类都实现接口（openCardread,cancelCardReader）,通过工厂模式创建各品牌的读卡模块</p>
<p>汇总：
1.抽象类实现一个接口(cardHandlerResult)，然后具体的类去继承抽象类（BaseCardActivitivity），便可选择性的复写需要的方法。</p>
<p>WithOutCardTrade 两种不需要卡的交易分别是小费和DCC转EDC</p>
<ul>
<li>刷卡消费 <br />
CILSDK.consume(request,callback);</li>
<li>刷卡撤销
CILSDK.revokeConsume(request,cardType,Callback);</li>
<li>刷卡退货
CILSDK.returnConsume(requst,cardtype,callback);</li>
<li>刷卡余额查询
CILSDK.checkBalance(request,cardtype,callback);</li>
<li>刷卡预授权
CILSDK.preAuth(request,cardtype,callback);</li>
<li>刷卡预授权完成
CILSDK.preAuthComplete(request,cardtype,callback);</li>
<li>DCC转EDC
CILSDK.dccToEdc(request,callback);  </li>
</ul>
<h4 id="_7">账单查询</h4>
<ul>
<li>获取账单列表<br />
CILSDK.getBillsAsync(pager,size,txtype,callback);</li>
<li>获取账单统计<br />
CILSDK.getBillStateAsync(type,callback)</li>
<li>根据凭证号获取订单详情（获取当前批次下得订单详情，凭证号：）
CILSDK.getBillByTraceNumAsync(trancenum,callback)</li>
</ul>
<h4 id="_8">结算</h4>
<p>每日交易结束得时候或收银员交接班时，对某段时间内得账款核对，商户每日交易结束得时候，收银员需要统计并核对所有得交易，核对交易统计准确后结算，打印出结算单，结算会涉及一个概念 批次号，我们在前面的交易都会传入一个批次号给request,调用结算后，后续的交易需要将这个批次号加一，因为此批次号已经打包结算掉了
CILSDK.transSettleAsync(batchNum,callback)  </p>
<h4 id="_9">打印</h4>
<ul>
<li>打印银行卡类交易、扫码类交易<br />
CILSDK.printKindsReceipts(trans，linebreak,formartTransCode,kind,isForeignTrans,callback);</li>
<li>打印结算小票
CILSDK.pintSettleReceipts(transSettles,transDatetime,batchNum,formatTransCode,lineBreak,formatTransCode,callback);</li>
<li>自定义打印 (超过2000个字符需要采用分段式打印，否则出现异常DeviceRTException) <br />
CILSDK.printBufferReceipt(buffer,lineBreak,callback);</li>
<li>打印二维码
CILSDK. printQRCode(qrCode,positon,width,linebreak,callback);</li>
<li>打印条形码
CILSDK.printBarCode(barCode,posion,lineBreak,callback);</li>
<li>打印图片
CILSDK.printImage(bitmap,lineBreak,offset,callback)  </li>
</ul>
<p>其他设置<br />
<em> 获取sdk版本号
CILSDK.VERSION_NAME;
CILSDK.VERSION_CODE;
* 获取sn号
CILSDK.getDeviceSN();<br />
</em> 设置流水号
CILSDK.setSericalNum(int serialNum);
* 获取流水号
CILSDK.getSerialNum();
* 设置批次号
CILSDK.setBatchNum(int batchNum);<br />
<em> 获取批次号
 CILSDK.getBatchNum();<br />
</em> 设置联迪密钥区(取值范围1~15)  需要在CILSDK.connect之前调用
CILSDK.setTingA8KeyIndex(2);
* 设置密钥索引(MAIN,MAC,PIN,MES)  需要在CILSDK.connect之前调用
CILSDK.setTingKeyIndex(4,101,10,150);</p>
<h4 id="uncaughtexceptionhandler">日志收集（uncaughtExceptionHandler）</h4>
<p>将日志写到sd文件中，然后上传的时候在从文件中取出上传</p>
<p>1.编译时异常在编码的时候就会提示编码人员进行try catch,运行时异常会出现忘记trycatch的现象，可以通过uncaughtExceptionHandler来进行捕获<br />
具体用法：继承这个类复写uncaughtException方法，具体的异常会回调到这个方法中（https://www.cnblogs.com/jadic/p/3532580.html）<br />
捕获后写到本地的sdcard中
2.上传log文件IntentService
     debugInfoActivity右上角的optionsMenu有上传日志的选项
    开启IntentService在handleIntent中执行上传日志操作
    开启线程池一条一条的上传日志SingleThreadExcutor</p>
<p>MainActivity--&gt;mainpagerFragment--&gt;DebugInfoActiivty标题栏的头像点击8下，进入调试暗门</p></div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Search</h4>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form role="form">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="Keyboard Shortcuts Modal" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title" id="exampleModalLabel">Keyboard Shortcuts</h4>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
